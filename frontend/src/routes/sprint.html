<svelte:head>
	<title>Running Late!</title>
</svelte:head>

<div class="">
	{#if start && current}
		<div>Started at: { start.latitude } x { start.longitude }</div>
		<div>Currently at: { current.latitude } x { current.longitude }</div>
		<div>Distance: { distance } km</div>
		<div>Time: { time } s</div>
		<div>Speed: { speed } km/h</div>
		{#if watchId}
			<button on:click="endGeo()">End!</button>
		{/if}
	{:else}
		<button on:click="startGeo()">Start!</button>
	{/if}
</div>

<script>
export default {
	data() {
		return {
			start: null,
			current: null,
			startTime: 0,
			currentTime: 1,
			watchId: 0,
		};
	},

	computed: {
		distance: ({start, current}) => calcCrow(start, current),
		time: ({startTime, currentTime}) => (currentTime - startTime) / 1000,
		speed: ({distance, time}) => distance / (time / (60 * 60)),
	},

	methods: {
		endGeo() {
			const {watchId} = this.get();
			navigator.geolocation.clearWatch(watchId);
			this.set({watchId: 0, currentTime: Date.now()});
		},
		startGeo() {
			const watchId = navigator.geolocation.watchPosition(({coords}) => {
				const timestamp = Date.now();
				if (!this.get().start) {
					this.set({
						start: coords,
						startTime: timestamp
					});
				}
				this.set({
					current: coords,
					currentTime: timestamp,
				});
			}, console.error);
			this.set({watchId});
		},
	},
};

function calcCrow(start, end) {
	if (!start || !end) return 0;

  const R = 6371; // km
  const dLatitude = asRadian(end.latitude - start.latitude);
  const dLongitude = asRadian(end.longitude - start.longitude);
  const startLatitude = asRadian(start.latitude);
  const endLatitude = asRadian(end.latitude);

  const a = Math.sin(dLatitude/2) * Math.sin(dLatitude/2) +
    Math.sin(dLongitude/2) * Math.sin(dLongitude/2) *
		Math.cos(startLatitude) * Math.cos(endLatitude);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  const d = R * c;
  return d;
}

// Converts numeric degrees to radians
function asRadian(degree) {
  return degree * Math.PI / 180;
}
</script>

<style>
</style>
